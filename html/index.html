<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>七大歧记</title>
    <link rel="preload" href="https://chinese-fonts-cdn.deno.dev/packages/jhlst/dist/%E4%BA%AC%E8%8F%AF%E8%80%81%E5%AE%8B%E4%BD%93v2_002/result.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <!--<link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/jhlst/dist/%E4%BA%AC%E8%8F%AF%E8%80%81%E5%AE%8B%E4%BD%93v2_002/result.css" media="print" onload="this.media='all'; this.onload=null;">-->
    <noscript>
        <link rel="stylesheet" href="https://chinese-fonts-cdn.deno.dev/packages/jhlst/dist/%E4%BA%AC%E8%8F%AF%E8%80%81%E5%AE%8B%E4%BD%93v2_002/result.css">
    </noscript>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: url('./img/bg.png');
            background-repeat: repeat-y;
            background-size: 100% auto;
            background-position: top center;
            font-family:'KingHwa_OldSong';
            font-weight:'400';
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        body * {
            font-family:'KingHwa_OldSong';
            font-weight:'400';
            transition: all ease .3s;
        }

        code {
            color: #45301cbb;
        }
        .banner {
            width: 100%;
            display: block;
        }
        .content {
            max-width: 800px;
            width:auto;
            width: 90%;
            margin: auto;
            margin-top: -0.5rem;
            margin-bottom: 1.5rem;
            padding: .5rem;
            font-size: 1.2em;
            color: #392410;
        }
        #nav {
            margin:auto;
        }

        a {
            color: inherit;
        }

        ul > li > p {
            margin-top:0;
            margin-bottom:0;
        }

        blockquote {
            border-left: .25rem solid #b07e24;
            margin-left: 0;
            margin-right: 0;
            padding-left: .5rem;
            color: inherit;
        }

        .giscus-frame{
            max-height: 90vh !important;
        }

        .image-container {
            display: flex;
            width: 100%;
            justify-content: center;
        }

        .image-container img {
            flex: 1;
            height: auto;
            width: 0;
            flex-grow: 1;
            object-fit: cover;
            border: 1px solid #ccc;
            display: block;
        }
        
        .auto-breakword > * {
            text-overflow: unset !important;
            overflow: unset;
            white-space: pre-wrap !important;
            word-break: break-all !important;
        }

        .auto-breakword {
            white-space: pre-wrap !important;
            word-break: break-all !important;
        }

        .nav-active {
            text-decoration: underline !important;
            filter: brightness(1.2) opacity(1) !important;
            color: #000 !important;
        }

        .nav-object {
            text-decoration: none;
            color: #666;
            filter: opacity(0.7) blur(0.25px);
        }

        .search-working {
            color: #666;
            transition: animation .2s ease;
            animation: anim-search-working 2s infinite ease-in-out;
        }

        @keyframes anim-search-working {
        0%, 100% {
            filter: drop-shadow( 0 10px 4px rgba(255, 204, 0, 0.6));
        }
        50% {
            filter: drop-shadow( 0 20px 8px rgba(255, 204, 0, 0.4));
        }
        }

        .search-error {
            color: #666;
            transition: animation .2s ease;
            animation: anim-search-error 2s infinite ease-in-out;
        }

        @keyframes anim-search-error {
        0%, 100% {
            filter: drop-shadow( 0 0 4px rgba(255, 0, 0, 0.6));
        }
        50% {
            filter: drop-shadow( 0 0 8px rgba(255, 0, 0, 0.5));
        }
        }
        .insp-highlight {
            outline: 2px solid #ff0000 !important; /* 使用 !important 确保覆盖原有样式 */
            background-color: rgba(255, 0, 0, 0.1) !important;
            cursor: pointer !important;
        }
        #nav-sidebar {
            display: flex;
            flex-direction: column;
            width: 16rem;
            height: 100%;
            position: fixed;
            right: 0;
            top: 0;
            background-color: #f6ead5c4;
            backdrop-filter: blur(5px);
            transition: width 0.3s;
            overflow: auto;
            overflow-x: hidden !important;
            z-index:69;
            color: #ddd;
        }

        #nav-sidebar-toc-list {
            list-style: none;
            padding: .25rem .75rem .25rem .5rem;
            margin-top: 0;
            margin-bottom: 0;
        }

        #nav-sidebar-sub {
            display: flex;
            flex-direction: column;
            width: 32rem;
            height: 100%;
            position: fixed;
            right: 0;
            top: 0;
            background-color: #f3e3c6b3;
            backdrop-filter: blur(8px);
            transition: width 0.3s;
            overflow: auto;
            overflow-x: hidden !important;
            z-index:64;
        }

        #nav-sidebar-wrapper {
            margin-top:auto;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 16rem;
            min-width: 16rem;
            max-width: 16rem;
            margin-bottom: 3rem;
        }

        #nav-sidebar-sub-wrapper {
            margin-top:auto;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 16rem;
            max-width: 16rem;
            min-width: 16rem;
            margin-bottom: 3rem;
        }

        #nav-sidebar-sub-wrapper p{
            margin:.125rem;
        }

        #nav-sidebar-wrapper > *, #nav-sidebar-sub-wrapper > * {
            margin: 0.5rem 5% 0 5%;
            min-width: 90%;
            max-width: 90%;
            flex-direction: column;
        }
        #nav-sidebar-wrapper *, #nav-sidebar-sub-wrapper * {
            display: flex;
            flex-direction: column;
        }
        #nav-sidebar-wrapper > button, #nav-sidebar-sub-wrapper > button, .nav-sidebar-btn {
            margin-left: 1rem;
            margin-right: 1rem;
            appearance:none !important;
            background-color:#f5f5f5;
            border:none;
            border-radius:0.75rem;
            box-shadow:0px 1px 2px #ecb24866;
            color:#2c2e31ff;
            outline:2px solid transparent !important;
        }

        .nav-sidebar-collapsed{
            width: 0 !important;
            overflow: hidden;
            overflow-x: hidden !important;
        }

        #nav-toggle-button {
            position: fixed;
            right: 28rem;
            bottom: 3.5rem;
            width: 6rem;
            height: 3rem;
            background-color: #705117b0;
            backdrop-filter: blur(3px);
            font-family: Arial, Helvetica, sans-serif;
            color: #f6ead5;
            border: none;
            cursor: pointer;
            border-radius: 1.5rem;
            font-size: 1.5rem;
            text-align: left;
            transition: transform .3s, bottom .3s, right .3s, width .3s;
            transform-origin: right;
            display: block;
            z-index: 60;
            transform: rotate(0deg);
            filter: drop-shadow(0 0 .4rem #bbb);
        }

        #nav-toggle-button-arrow {
            transition: transform 0.3s, bottom 0.3s, right 0.3s;
            transform-origin: center;
            display: block;
            width: fit-content !important;
            bottom: 0;
            transform: rotate(180deg);
            margin-left: .5rem;
        }

        .nav-sidebar-collapsed-btn #nav-toggle-button-arrow {
            display: block;
            /* right: .5rem; */
            margin-bottom: -1.25rem;
            transform: rotate(270deg);
        }

        #nav-toggle-button.nav-sidebar-sub-collapsed-btn {
            right: 12rem;
            bottom: 3.5rem;
            transform: rotate(0deg);
        }

        #nav-toggle-button.nav-sidebar-collapsed-btn.nav-sidebar-sub-collapsed-btn {
            display: block;
            right: .25rem;
            bottom: 1rem;
            width: 10rem;
            transform: rotate(90deg);
        }
        
        *::-webkit-scrollbar-track {
            display: none;
            background-color: rgba(255, 255, 255, 0);
            /*
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            border-radius: 10px;
            background-color: #F5F5F5;
            */
        }

        *::-webkit-scrollbar {
            width: .75rem;
            background-color: rgba(255, 255, 255, 0);
            position: fixed !important;
            right: 1rem;
            padding:2rem 1rem 2rem 0;
            /*background-color: #F5F5F5;*/
        }

        *::-webkit-scrollbar-thumb {
            border-radius: .625rem;
            /*-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);*/
            background-color: rgba(118, 118, 118, 0.56);
            margin: 2rem 1rem 2rem 0;
        }
        pattern {
            color: #705117;
            color: #c58d28;
            color: #e2ba71;
            color: #f3e3c6;
            color: #f6ead5;
            color: #e2ba71;
            color: #b07e24;
            color: #7199e2;
            color: #2455b0;
            color: #e2ba71;
            color: #b5e271;
            color: #71e282;
            color: #71e2d6;
            color: #7199e2;
            color: #9e71e2;
            color: #e271d2;
            color: #e2717d;
        }
        
        .multilist{
            list-style: none;
            padding: 1rem !important;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: .125rem;
            width: 100%;
        }

        .multilist{
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        @media screen and (max-width: 648px) {
            .multilist{
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
        }

        .multilist li {
            margin: .2rem !important;
            align-items: center;
            text-align: center;
            list-style: none;
            padding: 0;
        }

        .multilist li > * {
            margin: 0 ;
            padding: 0 ;
        }

        @media screen and (min-width: 1945px){
            .multilist li{
                max-width: 648px !important;
            }
        }
    </style>
</head>
<body>
    <img src="./img/banner.png" alt="Banner" class="banner">
        <div id="nav"><a href="./index.html" target="_blank" rel="noopener noreferrer">七大歧记</a>|<a href="./said.html" target="_blank" rel="noopener noreferrer">《七大云》</a>|<a href="./anno.html" target="_blank" rel="noopener noreferrer">重要讲话</a>|<a href="./hist.html" target="_blank" rel="noopener noreferrer">更新历史</a></div>
    <div class="content">
        ${content}
    </div>
    
    <div id="nav-sidebar" class="nav-sidebar-collapsed">
        <!-- 边栏内容 -->
        <div id="nav-sidebar-wrapper">
            <button onclick='toggleSidebarSub("nav-sidebar-sub-group-1","nav-sidebar-sub","nav-sidebar-sub-wrapper");'>站内信</button>
            <hr />
            <button onclick='toggleSidebarSub("nav-sidebar-sub-group-2","nav-sidebar-sub","nav-sidebar-sub-wrapper");'>传送门</button>
            <hr />
            <button onclick='toggleSidebarSub("nav-sidebar-sub-group-3","nav-sidebar-sub","nav-sidebar-sub-wrapper");'>看回放</button>
            <div is="search-bar" target='nav-sidebar-toc-list'></div>
            <ul id="nav-sidebar-toc-list" style="max-height:24rem;overflow-y: scroll!important;border-bottom: .125rem solid #000;" class="multilist-breakword">
                <li>当前页面不支持章节导航。</li>
            </ul>
        </div>
    </div>
    <button id="nav-toggle-button" onclick="toggleSidebar()"><div id="nav-toggle-button-arrow">&lt;</div></button>

    <!-- 二级菜单 -->
    <div id="nav-sidebar-sub">
        <div id="nav-sidebar-sub-wrapper">

            <div id="nav-sidebar-sub-group-1" class="nav-sidebar-group auto-breakword" sytle="padding:0.125rem;">
                <script src="https://giscus.app/client.js"
                    data-repo="EternalIllusion/Web-Giscus"
                    data-repo-id="R_kgDOPj1mtA"
                    data-category="Announcements"
                    data-category-id="DIC_kwDOPj1mtM4CukJr"
                    data-mapping="url"
                    data-strict="1"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="bottom"
                    data-theme="preferred_color_scheme"
                    data-lang="zh-CN"
                    data-loading="lazy"
                    crossorigin="anonymous"
                    async>
                </script>
                <p style="margin:auto" align="center">若无显 请等待 <a href="javascript:;" onclick='document.querySelector("iframe.giscus-frame").scrollTo({top:99999})''>显输入</a></p>
            </div>
            <div id="nav-sidebar-sub-group-2" class="nav-sidebar-group auto-breakword" sytle="padding:1rem;">
                <button onclick='linkact("https://ccbc16.cipherpuzzles.com/")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">西拾陆</button>
                <button onclick='linkact("https://triddles.ccbcarchive.com/")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">三字谜</button></a>
                <button onclick='linkact("https://brackets.ccbcarchive.com/")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">说带括</button></a>
                <button onclick='linkact("https://eterill.xyz/")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">吾博客</button></a>
                <button onclick='linkact("https://github.com/EternalIllusion/CCBC16-QiDaQiJi-Web")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">开源库</button></a>
                <button onclick='linkact("https://qm.qq.com/q/itWk4lAGQM")' class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">加群聊</button></a>
            </div>
            <div id="nav-sidebar-sub-group-3" class="nav-sidebar-group auto-breakword" sytle="padding:0.125rem;">
                <script src="./js/playback.js"></script>
                <p>输入格式如 <code>8.10 11:45</code> 抑或是 <code>8.10 11:45:14</code>或点击快速定位后点击时间文字</p>
                <button id="playback-insp" class="nav-sidebar-btn" style="margin: 0.5rem 5% 0.5rem 5%;min-width: 90%; max-width: 90%;">快速定位</button>
                <input id="playback-input" type="text" placeholder="输入时间点（月.日 时:分(:秒)）" style="margin:0 5% 0 5% !important;padding:0 5% 0 5%;width:90%;appearance:none !important;background-color:#f5f5f5;border:none;border-radius:0.75rem;box-shadow:0px -1px 2px #11182726;color:#2c2e31ff;outline:2px solid transparent !important;min-height:2.25rem !important;font-size:.875rem;line-height:1.25rem;margin:0;padding-block:1px;padding-inline:2px;overflow-clip-margin:0px !important;overflow:clip !important;box-sizing:border-box;" autocomplete="off">
                <div id="playback-status-div" style="margin:0.5rem 5% 0 5%;min-width: 90%; max-width: 90%; font-size: 0.8rem; color: #555;display: none;">
                    <p>匹配状态：<span id="playback-status-message"></span></p>
                    <p>BVid：<span id="playback-status-bvid"></span></p>
                    <a id="playback-link" target="_blank" href="#" rel="noopener noreferrer" style="justify-content: center;align-items: center;"  class="nav-sidebar-btn">跳转定位观看</a>
                </div>
                <button id="playback-get" onclick="getPlaybackLink()" class="nav-sidebar-btn" style="margin: 0.5rem 5% 0 5%;min-width: 90%; max-width: 90%;">获取链接</button>
            </div>
        </div>
    </div>
    </div>
    <script>
        let isTOCNavigating = false;
        let lastTOCDestination = 0;
        let timesTOCNavigatingOK = 0;
        function linkact(href) {
            if (!href || typeof href !== 'string') {
                console.error('Invalid href');
                return;
            }
            const url = /^https?:\/\//i.test(href) ? href : 'https://' + href;
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        function imgresize() {
            const imageContainers = document.querySelectorAll('.image-container');
            const maxHeight = 480;
            const maxHeightSingleA = 360;
            imageContainers.forEach(container => {
                const images = container.querySelectorAll('img');
                if (images.length === 0) return;
                if (images.length === 1) {
                    const img = images[0];
                    const maxHeightSingle = Math.min(maxHeightSingleA, img.naturalHeight*2);
                    let h = Math.min(maxHeightSingle, maxHeightSingle * (container.offsetWidth / (img.naturalWidth * (maxHeightSingle / img.naturalHeight))));
                    let w = img.naturalWidth * (h / img.naturalHeight);
                    img.style.height = h + 'px';
                    img.style.maxHeight = h + 'px';
                    img.style.width = w + 'px';
                    img.style.maxWidth = w + 'px';
                    return;
                }
                let totalNaturalWidth = 0;
                images.forEach(img => {
                    totalNaturalWidth += img.naturalWidth * (maxHeight / img.naturalHeight);
                });
                const containerWidth = container.offsetWidth;
                const scale = containerWidth / totalNaturalWidth;
                const actualHeight = Math.min(maxHeight, maxHeight * scale);
                images.forEach(img => {
                    const scaledWidth = img.naturalWidth * (actualHeight / img.naturalHeight);
                    img.style.height = actualHeight + 'px';
                    img.style.maxHeight = actualHeight + 'px';
                    img.style.width = scaledWidth + 'px';
                    img.style.maxWidth = scaledWidth + 'px';
                });
            });
        }
        window.addEventListener('DOMContentLoaded', function () {
            const lazyImages = document.querySelectorAll('img[loading="lazy"]');
            lazyImages.forEach(img => {
                img.addEventListener('load', function() {
                    imgresize();
                });
                img.addEventListener('error', function() {
                    console.error('图片加载失败:', this.src);
                });
            });
            imgresize();
        });
        window.addEventListener("resize", imgresize);

        function getPlaybackLink(){
            document.getElementById('playback-input').value && (()=>{const result= getPlaybackURL(document.getElementById('playback-input').value); document.getElementById('playback-status-message').textContent = result.message;document.getElementById('playback-status-div').style.display='flex'; if(result.success){ document.getElementById('playback-status-bvid').textContent = result.details.bvid; document.getElementById('playback-link').href = result.details.url;} else { document.getElementById('playback-status-bvid').textContent = ''; document.getElementById('playback-link').href = '#';}})()
        }

        /* 元素审查工具 */
        (function() {
            let isInspecting = false;
            let currentHighlightedElement = null;

            const toggleButton = document.getElementById('playback-insp');

            // 开始/停止检查模式
            toggleButton.addEventListener('click', function() {
                isInspecting = !isInspecting;
                if (isInspecting) {
                    startInspecting();
                } else {
                    stopInspecting();
                }
            });

            function startInspecting() {
                toggleButton.textContent = '取消快速定位';

                document.addEventListener('mouseover', handleMouseOver);
                document.addEventListener('mouseout', handleMouseOut);
                document.addEventListener('click', handleClick, true);
            }

            function stopInspecting() {
                toggleButton.textContent = '快速定位';
                
                document.removeEventListener('mouseover', handleMouseOver);
                document.removeEventListener('mouseout', handleMouseOut);
                document.removeEventListener('click', handleClick, true);

                if (currentHighlightedElement) {
                    currentHighlightedElement.classList.remove('insp-highlight');
                    currentHighlightedElement = null;
                }
            }

            function handleMouseOver(e) {
                if (isInspecting) {
                    if (e.target !== toggleButton && !toggleButton.contains(e.target)) {
                        if (currentHighlightedElement) {
                            currentHighlightedElement.classList.remove('insp-highlight');
                        }
                        e.target.classList.add('insp-highlight');
                        currentHighlightedElement = e.target;
                    }
                }
            }

            function handleMouseOut(e) {
                if (isInspecting) {
                    // 只有当鼠标离开当前高亮的元素时才移除高亮
                    // 注意：mouseover 和 mouseout 会冒泡，所以需要检查 relatedTarget
                    if (e.target === currentHighlightedElement && !isDescendant(currentHighlightedElement, e.relatedTarget)) {
                         // 不立即移除，让新的mouseover事件来处理
                         // 或者如果relatedTarget不在当前元素内，则移除
                         // 这里简单处理，依靠mouseover覆盖
                    }
                }
            }

            function handleClick(e) {
                if (isInspecting) {
                    if (e.target !== toggleButton && !toggleButton.contains(e.target)) {
                        e.preventDefault();
                        e.stopPropagation();
                        const selectedElement = e.target;
                        const textContent = getElementText(selectedElement);
                        const pbstr = findPlaybackTimeStr(textContent);
                        if (pbstr){
                            document.getElementById('playback-input').value = pbstr;
                            getPlaybackLink();
                            stopInspecting();
                        }
                    }
                }
            }

            function getElementText(element) {
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    return element.value || '';
                }
                return element.textContent.trim() || element.innerText.trim() || '';
            }
            
            function isDescendant(parent, child) {
                 if (!child) return false;
                 let node = child.parentNode;
                 while (node != null) {
                     if (node == parent) {
                         return true;
                     }
                     node = node.parentNode;
                 }
                 return false;
            }

        })();

        async function performSearch(query, inputDOM, itemDOM, flags = 'gi') {
        try {
            const items = itemDOM.querySelectorAll('li');
            const queryLower = query.toLowerCase();
            while(itemDOM.innerHTML.includes('<mark class="highlight">')) { itemDOM.innerHTML = itemDOM.innerHTML.replace('<mark class="highlight">', '').replace('</mark>', ''); }
            if (!queryLower.includes(' ')) {
            items.forEach((li, index) => {
                const text = (li.dataset.index || li.getAttribute('data-index') || li.textContent || li.innerHTML).trim();
                const textLower = text.toLowerCase();
                const regex = new RegExp(query, flags);
                if (regex.test(textLower)) {
                if (queryLower.length > 0) {
                    li.innerHTML = li.innerHTML.replace(/(<[^>]+>)|(&\S{1,4};)|([^<&]+)/gi, function (_, tag, entity, text) {
                    //console.log(`${tag} ${entity} ${text}`);
                    if (tag) return tag;
                    if (entity) return entity;
                    if (!text) return text;
                    return text.replace(regex, '<mark class="highlight">$&</mark>');
                    });
                    inputDOM.classList.remove('search-error');
                }
                li.style.display = 'list-item';
                } else {
                li.style.display = 'none';
                }
            });
            } else {
            const querykeywords = queryLower.split(' ');
            items.forEach((li, index) => {
                const text = (li.dataset.index || li.getAttribute('data-index') || li.textContent || li.innerHTML).trim();
                const textLower = text.toLowerCase();
                let willdisplay = true;
                querykeywords.forEach((kw, index) => {
                const regex = new RegExp(kw, flags);
                if (regex.test(textLower)) {
                    if (kw.length > 0) {
                    li.innerHTML = li.innerHTML.replace(/(<[^>]+>)|(&\S{1,4};)|([^<&]+)/gi, function (_, tag, entity, text) {
                        //console.log(`${tag} ${entity} ${text}`);
                        if (tag) return tag;
                        if (entity) return entity;
                        if (!text) return text;
                        return text.replace(regex, '<mark class="highlight">$&</mark>');
                    });
                    inputDOM.classList.remove('search-error');
                    }
                } else {
                    willdisplay = false;
                }
                });
                li.style.display = willdisplay ? 'list-item' : 'none';
            });
            }
            inputDOM.classList.remove('search-working');
        } catch (e) {
            inputDOM.classList.remove('search-working');
            inputDOM.classList.add('search-error');
            console.log(`search-error:${e}`);
        }
        }

        class SearchBar extends HTMLDivElement {
        constructor() {
            super();
        }
        connectedCallback() {
            this.target = this.getAttribute('target');
            this.inputId = this.getAttribute('inputid') || `searchbar-input-${Math.random().toString(16).slice(2)}`;
            this.baseColor = this.getAttribute('color') || '#2c2e31ff';
            this.shadowColor = this.getAttribute('shadowcolor') || '#11182726';
            this.defaultText = this.getAttribute('default') || '';
            this.placeholderText = this.getAttribute('placeholder') || 'Search...';
            this.innerHTML = `<svg style="color:${this.baseColor};height:1.25rem;left:1.25rem;opacity:.6;position:absolute;width:1.25rem;z-index:1;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0"></path></svg><input style="padding:0 .5rem 0 2.5rem !important;width:100%;appearance:none !important;background-color:#f5f5f5;border:none;border-radius:0.75rem;box-shadow:0px -1px 2px ${this.shadowColor};color:${this.baseColor};outline:2px solid transparent !important;min-height:2.25rem !important;font-size:.875rem;line-height:1.25rem;margin:0;padding-block:1px;padding-inline:2px;overflow-clip-margin:0px !important;overflow:clip !important;box-sizing:border-box;" id="${this.inputId}" value="${this.defaultText}" class="searchbar-input" type="text" placeholder="${this.placeholderText}" autocomplete="off">
            `;
            this.inputDOM = this.querySelector('input');
            this.style += "display:flex !important;padding:.25rem .5rem .25rem .5rem;box-sizing:border-box;align-items:center;position:relative;line-height:1.15;display:flex !important;justify-content:center;flex-direction:row;";
            const targetEL = this.target;
            const inputDOMEL = this.inputDOM;
            //console.log(targetEL);
            document.addEventListener('DOMContentLoaded', () => {
            //console.log(targetEL);
            let debounceTimer;
            const targetDOMEL = document.getElementById(targetEL);
            this.inputDOM.addEventListener('input', async (event) => {
                const query = event.target.value;
                inputDOMEL.classList.add('search-working');
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                await performSearch(query, inputDOMEL, targetDOMEL);
                }, 300);
            });
            });
        }
        }

        customElements.define('search-bar', SearchBar, { extends: 'div' });

        /* Cookie Utils */

        function setCookieBool(key, value) {
        var d = new Date();
        d.setTime(d.getTime() + (24 * 60 * 60 * 1000));
        document.cookie = `${key}=${(value ? 'true' : 'false')};expires=${d.toUTCString()};path=/`;
        }

        function setCookie(key, value) {
        var d = new Date();
        d.setTime(d.getTime() + (24 * 60 * 60 * 1000));
        document.cookie = `${key}=${value};expires=${d.toUTCString()};path=/`;
        }

        function getCookieBool(key, auto = false) {
        var name = `${key}=`;
        var ca = decodeURIComponent(document.cookie).split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            while (c.charAt(0) == ' ') { c = c.substring(1); }
            if (c.indexOf(name) == 0) { return c.substring(name.length, c.length) === 'true'; }
        }
        return auto; // 如果没有找到l项，默认返回False
        }

        function getCookie(key, auto = null) {
        var name = `${key}=`;
        var ca = decodeURIComponent(document.cookie).split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            while (c.charAt(0) == ' ') { c = c.substring(1); }
            if (c.indexOf(name) == 0) { return c.substring(name.length, c.length); }
        }
        return auto; // 如果没有找到l项，默认返回null
        }

        function toggleSidebar(id = 'nav-sidebar', toggleBtn = 'nav-toggle-button') {
        var sidebar = document.getElementById(id);
        var tbtn = document.getElementById(toggleBtn);
        if (sidebar.classList.contains('nav-sidebar-collapsed')) {
            sidebar.classList.remove('nav-sidebar-collapsed');
            tbtn.classList.remove('nav-sidebar-collapsed-btn');
            setCookieBool('navsidebar', true);
        } else {
            sidebar.classList.add('nav-sidebar-collapsed');
            tbtn.classList.add('nav-sidebar-collapsed-btn');
            closeSidebarSub();
            setCookieBool('navsidebar', false);
        }
        refreshSidebarBtn();
        }

        function toggleSidebarSub(currentid, id = 'nav-sidebar-sub', wrapperid = 'nav-sidebar-sub-wrapper', toggleBtn = 'nav-toggle-button') {
        var sidebar = document.getElementById(id);
        var parent = document.getElementById(wrapperid);
        var htm = document.getElementById(currentid);
        var tbtn = document.getElementById(toggleBtn);
        if (sidebar.classList.contains('nav-sidebar-collapsed')) {
            sidebar.classList.remove('nav-sidebar-collapsed');
            for (let i = 0; i < parent.children.length; i++) {
            parent.children[i].style.display = "none";
            }
            htm.style.display = "flex";
            sidebar.classList.remove('nav-sidebar-collapsed');
            tbtn.classList.remove('nav-sidebar-sub-collapsed-btn');
        } else {
            if (htm.style.display == "none") {
            for (let i = 0; i < parent.children.length; i++) {
                //console.log(parent.children[i]);
                parent.children[i].style.display = "none";
            }
            htm.style.display = "flex";
            } else {
            sidebar.classList.add('nav-sidebar-collapsed');
            tbtn.classList.add('nav-sidebar-sub-collapsed-btn');
            }
        }
        refreshSidebarBtn();
        }

        function closeSidebarSub(id = 'nav-sidebar-sub') {
            var sidebar = document.getElementById(id);
            sidebar.classList.add('nav-sidebar-collapsed');
            refreshSidebarBtn();
        }

        function refreshSidebarBtn(id = 'nav-toggle-button', sidebarid = 'nav-sidebar', sidebarsubid = 'nav-sidebar-sub') {
            var sidebar = document.getElementById(sidebarid);
            var sidebarsub = document.getElementById(sidebarsubid);
            var tbtn = document.getElementById(id);
            tbtn.classList.toggle('nav-sidebar-collapsed-btn', sidebar.classList.contains('nav-sidebar-collapsed'));
            tbtn.classList.toggle('nav-sidebar-sub-collapsed-btn', sidebarsub.classList.contains('nav-sidebar-collapsed'));
        }

        document.addEventListener('DOMContentLoaded', () => { refreshSidebarBtn(); });

        /* nav toc */

        document.addEventListener("DOMContentLoaded", function () {

        var selectors = [
            '.content',
            'body .container',
            'body'
        ];

        var content = null;

        // 根据选择器找到实际的文章内容容器
        for (var i = 0; i < selectors.length; i++) {
            content = document.querySelector(selectors[i]);
            if (content) break;
        }

        // 如果没有找到文章内容容器，则输出错误信息
        if (!content) {
            console.error("目录生成器无法找到内容容器。");
            return;
        }

        var headings = Array.from(content.querySelectorAll('h1, h2, h3, h4, h5, h6')).filter(function (heading) {
            return !heading.closest('#nav-sidebar, #nav-sidebar-sub, .card, .card-gallery');
        });

        var tocList = document.querySelector('#nav-sidebar-toc-list');
        tocList.innerHTML = '';

        // 计算目录中最小的标题等级（如h1、h2、h3等）
        let minLevel = 7;
        headings.forEach((heading) => {
            let level = parseInt(heading.tagName.substring(1));
            if (level < minLevel) {
            minLevel = level;
            }
        });
        headings.forEach(function (heading, index) {
            var id = 'nav-menu-heading-' + index;
            heading.id = id;

            var li = document.createElement('li');
            var a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.classList.add('nav-object');
            li.appendChild(a);
            var level = parseInt(heading.tagName.substring(1));
            li.style.marginLeft = (level - minLevel) * 0.5 + 'rem';
            //li.style.marginRight = 0.5 + 'rem';
            tocList.appendChild(li);
        });
        

tocList.addEventListener('click', function (event) {
    if (event.target.tagName.toLowerCase() === 'a') {
        event.preventDefault();
        const targetId = event.target.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (!targetElement) {
            console.warn(`Element #${targetId} not found`);
            return;
        }

        isTOCNavigating = true;
        console.log('TOC navigating started');
        const initialScrollPosition = targetElement.getBoundingClientRect().top + window.scrollY - 80; // 80px 偏移量
        window.scrollTo({
            top: initialScrollPosition,
            behavior: 'smooth'
        });
        lastTOCDestination = initialScrollPosition;
        timesTOCNavigatingOK = 0;
        // 监听滚动结束并校正位置
        let scrollTimeout;
        const checkScrollEndAndCorrectPosition = () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const initialScrollPositionNew = targetElement.getBoundingClientRect().top + window.scrollY - 80; // 80px 偏移量
                if (lastTOCDestination!== initialScrollPositionNew) {
                    timesTOCNavigatingOK = 0;
                    console.log('Adjusting scroll position due to layout changes');
                    window.scrollTo({
                        top: initialScrollPositionNew,
                        behavior: 'smooth'
                    });
                    lastTOCDestination = initialScrollPositionNew;
                } else {
                    timesTOCNavigatingOK += 1;
                    console.log('Target Seems is in view');
                    if (timesTOCNavigatingOK >= 2) {
                        console.log('TOC navigating ended');
                        isTOCNavigating = false;
                        history.pushState(null, null, '#' + targetId);
                    }
                }
            }, 75);
        };

        window.addEventListener('scroll', checkScrollEndAndCorrectPosition, { passive: true });
        checkScrollEndAndCorrectPosition();

        setTimeout(() => {
            window.removeEventListener('scroll', checkScrollEndAndCorrectPosition);
            clearTimeout(scrollTimeout);
            if (isTOCNavigating){
                console.log('Timeout, no need for adjustment');
                isTOCNavigating = false;
                history.pushState(null, null, '#' + targetId);
            }
            
        }, 2000); // 假设最长等待时间为2秒，根据实际情况调整
    }
});

        function highlightCurrentHeading() {
            let currentHeadingId = null;
            const offset = 100;  // 滚动时的偏移量

            // 查找当前视口中的标题
            for (let i = 0; i < headings.length; i++) {
            const rect = headings[i].getBoundingClientRect();
            if (rect.top <= offset) {
                currentHeadingId = headings[i].id;
            } else {
                break;
            }
            }
            let targetLabel = null;

            // 高亮当前标题的目录项
            tocList.querySelectorAll('a').forEach(function (a) {
            if (a.getAttribute('href').substring(1) === currentHeadingId) {
                a.classList.add('nav-active');
                targetLabel = a;
            } else {
                a.classList.remove('nav-active');
            }
            });

            if (targetLabel) {
                const labelRect = targetLabel.getBoundingClientRect();
                const tocRect = tocList.getBoundingClientRect();
                
                // 计算应滚动到的位置（相对于 tocList 内容）
                const relativeTop = labelRect.top - tocRect.top + tocList.scrollTop;
                
                tocList.scrollTo({
                    top: relativeTop - 36, // -10 是留点上边距
                    behavior: 'smooth',
                    block: 'nearest' // 可选：避免不必要的滚动
                });
            }
        }

        // 监听滚动事件以更新当前高亮的目录项
        window.addEventListener('scroll', highlightCurrentHeading);
        highlightCurrentHeading();  // 初始化高亮

        });


        closeSidebarSub();
        if (getCookieBool('navsidebar')) {
            toggleSidebar();
        }
        refreshSidebarBtn();
    </script>
</body>
</html>